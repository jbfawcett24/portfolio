---

---

<form>
    <h3>Have a project? Get in touch</h3>
    <div id="left">
    <div>
        <label for="formName">Name</label>
        <input type="text" name="name" id="formName">
    </div>
    <div>
        <label for="email">Email</label>
        <input type="email" name="email" id="email">
    </div>
    </div>
    <div id="messageDiv">
        <label for="message">Message</label>
        <textarea name="message" id="message" rows="4" cols="50"></textarea>
    </div>
    <input type="text" name="favorite-color" id="favorite-color" class="fav-color">
    <p id="error"></p>
    <button id="submit">Submit</button>
</form>

<style>
    .fav-color {
        display: none;
    }
    form {
        display: flex;
        flex-direction: column;
    }

    form {
        display: grid;
        grid-template-columns: auto auto;
        gap: 2%;
        grid-template-rows: auto 1fr 1fr;
        align-items: center;
        justify-content: center;
    }
    h3 {
        grid-column: 1/3;
        grid-row: 1/2;
        text-align: center;
        color: rgba(232, 149, 149, 1);
        font-size: 1.5rem
    }
    #left {
        margin: 2%;
        margin-bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        justify-content: flex-start;
        div {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            align-items: center;
            label {
                margin-right: 10px;
            }
        }
        input {
            max-width: 150px;
            height: 25px;
        }
    }
    form > div > div {
        width:100%;
        label {
            text-align: right;
        }
    }

    #messageDiv {
        display: flex;
        flex-direction: column;
        label {
            text-align: center;
        }
    }
    textarea {
        resize: none;
    }
    button {
        width: 60%;
        margin: auto;
        min-height: 30px;
        border: none;
        grid-column: 1/-1;
        grid-row: 3/-1;
        background-color: rgba(232, 149, 149, 1);
        padding: 1% 1.5%;
        border-radius: 10px;
        text-decoration: none;
        color: rgba(19, 17, 38);
        transition: all 0.2s ease;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background-color: rgba(232, 149, 149, 0.7);
    }
    #error {
        color: rgb(255, 100, 80);
        grid-column: 1/-1;
        font-size: 0.7rem;
    }

    @media (max-width: 768px) {
        form {
            /* Reset grid to a simple single-column flow */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 1.5rem;
            padding: 0;
            overflow: hidden;
        }

        /* Group headings and containers to 90% and center them */
        h3, #left, #messageDiv, #error {
            width: 90%;
            margin: 0 auto;
            grid-column: auto !important; /* Break the grid rules */
        }

        /* Fix the internal name/email divs */
        #left {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #left div {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        #left div label {
            text-align: left;
            margin-bottom: 5px;
        }

        /* Critical: Force inputs and textarea to stay inside their parents */
        input, textarea {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box; /* Includes padding in the width calculation */
        }

        #messageDiv {
            display: flex;
            flex-direction: column;
        }

        #messageDiv label {
            text-align: left;
            margin-bottom: 5px;
        }

        /* The Button Fix */
        button {
            width: 90% !important; /* Matches the width of other containers */
            margin: 10px auto !important;
            grid-column: auto !important;
            grid-row: auto !important;
            box-sizing: border-box;
            /* Remove fixed heights if any, let padding do the work */
            min-height: 45px;
        }
    }
</style>

<script>
    import {actions, isInputError} from "astro:actions";
    const button = document.querySelector("#submit");
    button?.addEventListener("click", async (e) => {
        e.preventDefault();

        if(getInputValue("favorite-color") !== "") return;

        const errorEl = document.querySelector("#error") as HTMLElement | null;
        if (errorEl) errorEl.textContent = "";

        const { data, error } = await actions.sendEmail({
            email: getInputValue("email"),
            name: getInputValue("formName"),
            message: getInputValue("message")
        })
        if(error){
            console.log(error)
            if(errorEl) {
                if (isInputError(error)) {
                    const messages = Object.values(error.fields).flatMap(f => f);
                    errorEl.textContent = "Error: " + messages.join(", ")
                } else {
                    errorEl.textContent = "Error: An unexpected server error has occurred."
                }
            }
        } else {
            const event = new CustomEvent('email-success', {
                detail: {
                    message: "Email Sent"
                }
            })
            window.dispatchEvent(event)
            console.log(event);
        }
    })

    function getInputValue(id:string) {
        const el = document.getElementById(id) as HTMLInputElement | null;
        if (el) {
            return el.value;
        }
        return "";
    }
</script>
